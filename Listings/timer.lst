C51 COMPILER V9.60.0.0   TIMER                                                             12/21/2021 17:57:20 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE TIMER
OBJECT MODULE PLACED IN .\Objects\timer.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Source\timer.c LARGE OPTIMIZE(9,SIZE) BROWSE INCDIR(.\Include;.\FreeModB
                    -us\Inc) DEBUG OBJECTEXTEND PRINT(.\Listings\timer.lst) OBJECT(.\Objects\timer.obj)

line level    source

   1          #include "timer.h"
   2          #include "systemTimer.h"
   3          
   4          TIM_HandleTypeDef Timer0;
   5          PUBLIC_TIMER16 PublicTimer16;
   6          
   7          /*********************************************************
   8          * 函数名：void WDT_init(void)
   9          * 功能：  初始化看门狗
  10          * 参数：
  11          * 作者：
  12          * note：
  13          *
  14          **********************************************************/
  15          //void WDT_init(void)
  16          //{
  17          ////  WDT_CONTR = 0x23;                           //使能看门狗,溢出时间约为0.5s
  18          //    WDT_CONTR = 0x24;                           //使能看门狗,溢出时间约为1s
  19          ////  WDT_CONTR = 0x27;                           //使能看门狗,溢出时间约为8s
  20          //}
  21          
  22          //void CLRWDT(void)
  23          //{
  24          //              WDT_CONTR |= 0x10;//喂狗
  25          //}
  26          
  27          /*********************************************************
  28          * 函数名： Timer0_Init()
  29          * 功能：   定时器0 的初始化设置
  30          * 参数：   无
  31          * 作者：   LHC
  32          * note：
  33          *                  定时器2、3、4均工作在16bit自动重载模式
  34          **********************************************************/
  35          
  36          void Timer0_Init(void)
  37          {
  38   1              Timer0.Instance = TIMER0;
  39   1              Timer0.Register_AUXR = T0X12; //12T模式
  40   1              Timer0.Timer_Mode = 0x00;
  41   1              Timer0.Timer_Count = (COUNTMAX - (T12_MODE));
  42   1              Timer0.RunTimer_Enable = true;            //开启定时器0
  43   1              Timer0.Interrupt_Enable = true;           //开启定时器0中断
  44   1              Timer0.Timer_NVIC.Register_IP = 0x20; //定时器0优先级为11，最高优先级
  45   1              Timer0.Timer_NVIC.Register_IPH = 0x20;
  46   1              TIM_Base_MspInit(&Timer0);
  47   1      }
  48          
  49          void TIM_Base_MspInit(TIM_HandleTypeDef *const tim_baseHandle)
  50          {
  51   1              if (tim_baseHandle->Instance == TIMER0)
  52   1              { //首次初始化，把TMOD和AUXR全部置零
  53   2                      AUXR = tim_baseHandle->Register_AUXR;
  54   2                      TMOD = tim_baseHandle->Timer_Mode;                        //模式0
C51 COMPILER V9.60.0.0   TIMER                                                             12/21/2021 17:57:20 PAGE 2   

  55   2                      TL0 = (uint8_t)(tim_baseHandle->Timer_Count); //65536-11.0592M/12/1000
  56   2                      TH0 = (uint8_t)((tim_baseHandle->Timer_Count) >> 8);
  57   2                      TR0 = tim_baseHandle->RunTimer_Enable;  //启动定时器
  58   2                      ET0 = tim_baseHandle->Interrupt_Enable; //使能定时器中断
  59   2                      IP |= tim_baseHandle->Timer_NVIC.Register_IP;
  60   2                      IPH |= tim_baseHandle->Timer_NVIC.Register_IPH;
  61   2                      //              EA = 1;
  62   2              }
  63   1      }
  64          
  65          /**/
  66          /**
  67           * @brief       定时器0的中断服务函数
  68           * @details     
  69           * @param       None
  70           * @retval      None
  71           */
  72          void Timer0_ISR() interrupt 1 using 1
  73          {
  74   1              /*软件定时器*/
  75   1              // systemTimer();
  76   1              SET_SOFTTIMER_FLAG(PublicTimer16);
  77   1      
  78   1              if(COM_UART1.LNode[COM_UART1.Wptr].Timer_Flag)
  79   1                      /*以太网串口接收字符间隔超时处理*/
  80   1                      SET_FRAME(COM_UART1);
  81   1              if(COM_UART2.LNode[COM_UART2.Wptr].Timer_Flag)
  82   1                      /*4G/WiFi串口接收字符间隔超时处理*/
  83   1                      SET_FRAME(COM_UART2);
  84   1              if(COM_UART3.LNode[COM_UART3.Wptr].Timer_Flag)
  85   1                      /*RS485串口接收字符间隔超时处理*/
  86   1                      SET_FRAME(COM_UART3);
  87   1              if(COM_UART4.LNode[COM_UART4.Wptr].Timer_Flag)
  88   1                      /*PLC串口接收字符间隔超时处理*/
  89   1                      SET_FRAME(COM_UART4);
  90   1      }
  91          
  92          
  93          void Delay_ms(unsigned short time)
  94          {
  95   1          unsigned short temp;
  96   1      
  97   1          temp = time;
  98   1      
  99   1          while(temp --)
 100   1          {
 101   2              Delay1ms();
 102   2          }
 103   1      }
 104          
 105          /*禁止编译器优化该模块*/
 106          // #pragma OPTIMIZE(0)
 107          
 108          void Delay1ms()         //@11.0592.000MHz
 109          {
 110   1          unsigned char i, j;
 111   1      
 112   1          i = 11;
 113   1          j = 190;
 114   1      
 115   1          do
 116   1          {
C51 COMPILER V9.60.0.0   TIMER                                                             12/21/2021 17:57:20 PAGE 3   

 117   2              while (--j);
 118   2          }
 119   1          while (--i);
 120   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    503    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     16       2
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)

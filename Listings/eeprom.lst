C51 COMPILER V9.60.0.0   EEPROM                                                            09/22/2021 09:56:55 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE EEPROM
OBJECT MODULE PLACED IN .\Objects\eeprom.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Source\eeprom.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\Include;.\FreeMo
                    -dBus\Inc) DEBUG OBJECTEXTEND PRINT(.\Listings\eeprom.lst) OBJECT(.\Objects\eeprom.obj)

line level    source

   1          #include"config.h"
   2          #include"eeprom.h"
   3          #include"systemtimer.h"
   4          
   5          
   6           /*********************************************************
   7          * å‡½æ•°åï¼šIapConfigWaitTime()
   8          * åŠŸèƒ½ï¼š  é…ç½®STC8å•ç‰‡æœºEEPROMçš„ç­‰å¾…æ—¶é—´
   9          * å‚æ•°ï¼š
  10          * ä½œè€…:
  11          * noteï¼š
  12          *
  13          **********************************************************/
  14          static void IapConfigWaitTime()
  15          {
  16   1              uint32_t XTAL = FOSC/1000000;
  17   1              
  18   1              if(XTAL>= 30) //>=30M
  19   1                      IAP_CONTR = 0x80;
  20   1              else if(XTAL >= 24)
  21   1                      IAP_CONTR = 0x81;
  22   1              else if(XTAL >= 20)
  23   1                      IAP_CONTR = 0x82;
  24   1              else if(XTAL >= 12)
  25   1                      IAP_CONTR = 0x83;
  26   1              else if(XTAL >= 6)
  27   1                      IAP_CONTR = 0x84;
  28   1              else if(XTAL >= 3)
  29   1                      IAP_CONTR = 0x85;
  30   1              else if(XTAL >= 2)
  31   1                      IAP_CONTR = 0x86;
  32   1              else
  33   1                      IAP_CONTR = 0x87;
  34   1      }
  35          
  36          
  37           /*********************************************************
  38          * å‡½æ•°åï¼švoid IapIdle()
  39          * åŠŸèƒ½ï¼š
  40          * å‚æ•°ï¼š
  41          * ä½œè€…:
  42          * noteï¼š
  43          *
  44          **********************************************************/
  45          void IapIdle()
  46          {
  47   1          IAP_CONTR = 0x00;                              //å…³é—­IAPåŠŸèƒ½
  48   1          IAP_CMD = 0x00;                                //æ¸…é™¤å‘½ä»¤å¯„å­˜å™¨
  49   1          IAP_TRIG = 0x00;                               //æ¸…é™¤è§¦å‘å¯„å­˜å™¨
  50   1          IAP_ADDRH = 0x80;                           //å°†åœ°å€è®¾ç½®åˆ°éIAPåŒºåŸŸ
  51   1          IAP_ADDRL = 0x00;
  52   1      }
  53          
  54          
C51 COMPILER V9.60.0.0   EEPROM                                                            09/22/2021 09:56:55 PAGE 2   

  55           /*********************************************************
  56          * å‡½æ•°åï¼šchar IapRead(unsigned short addr)
  57          * åŠŸèƒ½ï¼š  è¯»å‡½æ•°  è¯»å‡ºä¸€ä¸ªå­—èŠ‚
  58          * å‚æ•°ï¼š
  59          * ä½œè€…ï¼š
  60          * noteï¼š
  61          *
  62          **********************************************************/
  63          char IapRead(char addr)
  64          {
  65   1          char dat = 0x00;
  66   1      
  67   1              IapConfigWaitTime();
  68   1              IAP_CMD = 0x01;                         //EEPROMè¯»å‘½ä»¤
  69   1              IAP_ADDRL = addr & 0xFF;
  70   1              IAP_ADDRH = addr >> 8;
  71   1              IAP_TRIG = 0x5A;                        //è§¦å‘æŒ‡ä»¤
  72   1              IAP_TRIG = 0xA5;
  73   1              dat = IAP_DATA;
  74   1      
  75   1              if(IAP_CONTR & 0x10)
  76   1              {
  77   2                      IAP_CONTR &= 0xEF;
  78   2                      return 0x2333;
  79   2              }
  80   1              else return dat;
  81   1      }
  82          
  83          /*********************************************************
  84          * å‡½æ•°åï¼švoid IapProgram(unsigned short addr, char dat)
  85          * åŠŸèƒ½ï¼š  æŒ‡å®šåœ°å€å†™æ•°æ®
  86          * å‚æ•°ï¼š
  87          * ä½œè€…ï¼š
  88          * noteï¼š
  89          *
  90          **********************************************************/
  91          
  92          void IapProgram(unsigned short addr, unsigned char dat)
  93          {
  94   1      //    IAP_CONTR = WT_12M;//WT_24M;                //ä½¿èƒ½IAP
  95   1              IapConfigWaitTime();
  96   1          IAP_CMD = 0x02;                                //è®¾ç½®IAPå†™å‘½ä»¤
  97   1          IAP_ADDRL = (unsigned char)addr;                           //è®¾ç½®IAPä½åœ°å€
  98   1          IAP_ADDRH = (unsigned char)addr >> 8;                      //è®¾ç½®IAPé«˜åœ°å€
  99   1          IAP_DATA = dat;                             //å†™IAPæ•°æ®
 100   1          IAP_TRIG = 0x5a;                            //å†™è§¦å‘å‘½ä»¤(0x5a)
 101   1          IAP_TRIG = 0xa5;                            //å†™è§¦å‘å‘½ä»¤(0xa5)
 102   1          //_nop_();
 103   1      //      Delay_ms(5);//å»¶æ—¶5æ¯«ç§’
 104   1          IapIdle();                                  //å…³é—­IAPåŠŸèƒ½
 105   1                      
 106   1      }
 107          
 108          /*********************************************************
 109          * å‡½æ•°åï¼švoid IapErase(int addr)
 110          * åŠŸèƒ½ï¼š  æ“¦é™¤æŒ‡å®šåœ°å€çš„å†…å®¹
 111          * å‚æ•°ï¼š
 112          * ä½œè€…ï¼š
 113          * noteï¼šæ“¦é™¤æ¯æ¬¡æŒ‰ç…§512Bè¿›è¡Œï¼Œä»…æä¾›é¦–åœ°å€å³å¯
 114          *
 115          **********************************************************/
 116          void IapErase(unsigned short addr)
C51 COMPILER V9.60.0.0   EEPROM                                                            09/22/2021 09:56:55 PAGE 3   

 117          {
 118   1      //    IAP_CONTR = WT_12M;//WT_24M;                         //ä½¿èƒ½IAP
 119   1              IapConfigWaitTime();
 120   1          IAP_CMD = 0x03;                                //è®¾ç½®IAPæ“¦é™¤å‘½ä»¤
 121   1          IAP_ADDRL = (unsigned char)addr;                           //è®¾ç½®IAPä½åœ°å€
 122   1          IAP_ADDRH = (unsigned char)addr >> 8;                      //è®¾ç½®IAPé«˜åœ°å€
 123   1          IAP_TRIG = 0x5a;                            //å†™è§¦å‘å‘½ä»¤(0x5a)
 124   1          IAP_TRIG = 0xa5;                            //å†™è§¦å‘å‘½ä»¤(0xa5)
 125   1          //_nop_();                                    //
 126   1          IapIdle();                                  //å…³é—­IAPåŠŸèƒ½
 127   1                      Delay_ms(4);//å»¶æ—¶5æ¯«ç§’
 128   1      }
 129          
 130          /*********************************************************
 131          * å‡½æ•°åï¼švoid EEPROM_writeString(unsigned short Address,unsigned char *Pdata,unsigned short length);
 132          * åŠŸèƒ½ï¼š  æŒ‡å®šåœ°å€ å†™å…¥æ•°æ®
 133          * å‚æ•°ï¼š
 134          * ä½œè€…ï¼š
 135          * noteï¼šå†™æ•°æ®ä¸€èˆ¬è¯·æŒ‰ç…§ä¸€ä¸ªæ‰‡åŒºä¸€ä¸ªæ‰‡åŒºçš„æ¥å†™ï¼Œä¸ç„¶åœ¨æ“¦é™¤æ•°æ®çš„æ—¶å€™ä¼šé€ æ
             -ˆæ•°æ®ä¸¢å¤±
 136          * ä¸€ä¸ªæ‰‡åŒºçš„å¤§å°æ˜¯ 512å­—èŠ‚
 137          *
 138          *
 139          *               
 140          ***********************************************************************************/
 141          bit IapWrite_Buff(uint16_t Addr,const uint8_t *Str,uint8_t Len)
 142          {
 143   1              while(Len--)
 144   1              {
 145   2                      IapProgram(Addr++,*Str++);
 146   2              }
 147   1              return 1;
 148   1      }
 149          
 150          
 151          bit IapRead_Buff(uint16_t Addr,uint8_t *Str,uint8_t Len)
 152          {
 153   1              while(Len--)
 154   1              {
 155   2                      *Str++ = IapRead(Addr++);
 156   2              }
 157   1              return 1;
 158   1      }
 159          
 160          
 161          
 162          
 163          
 164          
 165          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    502    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      22
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)

C51 COMPILER V9.60.0.0   WIFI                                                              12/21/2021 17:57:20 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE WIFI
OBJECT MODULE PLACED IN .\Objects\wifi.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Source\wifi.c LARGE OPTIMIZE(9,SIZE) BROWSE INCDIR(.\Include;.\FreeModBu
                    -s\Inc) DEBUG OBJECTEXTEND PRINT(.\Listings\wifi.lst) OBJECT(.\Objects\wifi.obj)

line level    source

   1          /********************************************************************
   2           **--------------文件信息---------------------------------------------
   3           **文   件   名：wifi.h
   4           **创 建  日 期：2019年3月1日
   5           **最后修改日期：
   6           **版 权 信  息: 云南兆富科技有限公司
   7           **程   序   员：张东海
   8           **版   本   号：V1.0
   9           **描        述：WIFI驱动程序（RAK425）
  10           **修 改 日  志:
  11           *********************************************************************/
  12          
  13          #include "wifi.h"
  14          #include "systemTimer.h"
  15          #include "usart.h"
  16          
  17          
  18          /*USR-C210模块AT指令列表*/
  19          const AT_Command code Wifi_Cmd[] =
  20          {
  21                  /*WIFI模块推出透传模式进入AT指令模式*/
  22                  {"+++", "a", 1000U,  NULL},
  23                  /*WIFI模块响应后，主动发送”a“*/
  24                  {"a",   "+Ok", 200U, NULL},
  25                  /*关闭回显*/ 
  26                  //{"AT+E=OFF\r\n", "+OK", 500},           
  27                  /*显示SSID*/ 
  28                  //{"AT+HSSID = OFF\r\n", "+OK", 500}, 
  29                  /*WIFI工作模式：AP + STA*/ 
  30                  {AP_STA_MODE, "+OK", 200U, NULL},        
  31                  /*设置路由器名称*/ 
  32                  {AP_NAME, "+OK", 200U, NULL},
  33                  /*设置心跳数据:www.ynpax.com*/ 
  34                  {"AT+HEARTDT=7777772E796E7061782E636F6D\r\n", "+OK", 200U, NULL},   
  35                  /*SSID和密码不能程序输入，需要在现场根据用户方的WIFI设置通过WEB方式修改*/
  36                  /*设置WIFI登录SSID，密码*/ 
  37                  {"AT+WSTA=union,*!ynzfkj20091215!*\r\n", "+OK", 200U, NULL}, 
  38                  /*透传云设置*/       
  39                  {"AT+REGENA=CLOUD,FIRST\r\n", "+OK", 200U, NULL},
  40                  /*设置STOCKA参数*/
  41                  {"AT+SOCKA=TCPC,cloud.usr.cn,15000\r\n", "+OK", 200U, NULL},
  42                  /*设置搜索服务器和端口*/
  43                  {"AT+SEARCH=15000,cloud.usr.cn\r\n", "+OK", 200U, NULL},
  44                  /*透传云ID，透传云密码*/  
  45                  {CLOUD_ID, "+OK", 200U, NULL},
  46                  /*设置DHCP*/ 
  47                  {"AT+WANN=DHCP\r\n", "+OK", 200U, NULL},
  48                  /*软件重启USR-C210*/
  49                  {"AT+Z\r\n", "+OK", 200U, NULL},  
  50                  /*设置透传模式*/     
  51                  // {"AT+ENTM\r\n", "+OK", 50U, NULL}    
  52          };
  53          
  54          #define WIFI_CMDSIZE sizeof(Wifi_Cmd) / sizeof(AT_Command)
C51 COMPILER V9.60.0.0   WIFI                                                              12/21/2021 17:57:20 PAGE 2   

  55          
  56          /**
  57           * @brief       WIFI模块从透传模式退出到命令模式
  58           * @details     
  59           * @param       None
  60           * @retval      None
  61           */
  62          // void wifi_cmd_mode(void)
  63          // {
  64          //      char str[] = "+++";
  65          //      wifi_sendcmd((uint8_t*)str,strlen(str));
  66          // }
  67          
  68          // void wifi_ReciveNew(uint8_t* rxBuf,uint16_t Len)
  69          // {
  70          //      uint16_t i;
  71          //      for(i = 0;i<Len;i++)
  72          //      {
  73          //              g_Wifi.RxBuf[i] = rxBuf[i];
  74          //      }
  75          //      g_Wifi.RxCount = Len;
  76          // }
  77          
  78          // void wifi_Poll(void)
  79          // {
  80          //      wifi_AnalyzeApp();
  81          //      g_Wifi.RxCount = 0;
  82          // }
  83          
  84          // void wifi_AnalyzeApp(void)
  85          // {
  86          //      if(g_Wifi.RxBuf[0] == 0x61 && g_Wifi.RxCount == 1)
  87          //      {
  88          //              cmdmodeflag = 1;
  89          //              wifisend_a();
  90          // //           WifiCmdLight(0);     /*这一段可以不用，有点耦合*/
  91          //      }
  92          //      if(cmdmodeflag)  /*如果是在命令模式下*/
  93          //      {
  94          
  95          //      }
  96          // }
  97          
  98          // void wifisend_a(void)
  99          // {
 100          //      char str = 'a';
 101          //      wifi_sendcmd((uint8_t*)&str, 1U);
 102          // }
 103          
 104          // void wifi_sendcmd(uint8_t * dat,uint8_t length)
 105          // {
 106          //      Uartx_SendStr(&Uart2, dat, length);
 107          // }
 108          
 109          // void AT_SetWap(char* ssid,char* key)
 110          // {
 111          //      char str[50] = "AT+WAP=";
 112          //      char*pstr = str;
 113          //      // assert_param((ssid!=NULL)&&(key!=NULL)); //检查参数是否正确
 114          
 115          //      if(strlen(key) < 8)
 116          //      {
C51 COMPILER V9.60.0.0   WIFI                                                              12/21/2021 17:57:20 PAGE 3   

 117          //              AT_error("length too short");
 118          //              return;
 119          //      }
 120          
 121          //      while(*pstr)
 122          //      {
 123          //              pstr++;
 124          //      }
 125          //      while(*ssid)
 126          //      {
 127          //              *pstr++ = *ssid++;
 128          //      }
 129          //      *pstr++ = ',';
 130          //      while(*key)
 131          //      {
 132          //              *pstr++ = *key++;
 133          //      }
 134          //      *pstr++ = '\r';
 135          //      *pstr++ = '\n';
 136          //      wifi_sendcmd((uint8_t*)str,strlen(str));
 137          // }
 138          
 139          // void SetUpWifi(char*ssid,char* key)
 140          // {
 141          //      char str[100] = "AT+WSTA=";
 142          //      char*pstr = str;
 143          //      // assert_param((ssid!=NULL)&&(key!=NULL)); //检查参数是否正确
 144          
 145          //      if(strlen(ssid)> 32U)
 146          //      {
 147          //              AT_error("length too long");
 148          //      }
 149          
 150          //      while(*pstr)
 151          //      {
 152          //              pstr++;
 153          //      }
 154          //      while(*ssid)
 155          //      {
 156          //              *pstr++ = *ssid++;
 157          //      }
 158          //      *pstr++ = ',';
 159          //      while(*key)
 160          //      {
 161          //              *pstr++ = *key++;
 162          //      }
 163          //      *pstr++ = '\r';
 164          //      *pstr++ = '\n';
 165          //      wifi_sendcmd((uint8_t*)str,strlen(str));
 166          // }
 167          
 168          // void AT_Reload(void)
 169          // {
 170          //      char str[20] = "AT+Z\r\n";
 171          //      wifi_sendcmd((uint8_t*)str,strlen(str));
 172          // }
 173          
 174          // void AT_error(char* error)
 175          // {
 176          //      Uartx_SendStr(&Uart2, error, strlen(error));
 177          // }
 178          
C51 COMPILER V9.60.0.0   WIFI                                                              12/21/2021 17:57:20 PAGE 4   

 179          
 180          /**
 181           * @brief       WIFI模块启停
 182           * @details     
 183           * @param       status:状态
 184           * @retval      None
 185           */
 186          void Wifi_Enable(uint8_t status)
 187          {
 188   1              switch(status)
 189   1              {
 190   2                      case true:
 191   2                      {
 192   3                              WIFI_RESET  = 1;
 193   3                      }break;
 194   2                      case false:
 195   2                      {
 196   3                              WIFI_RESET  = 0;
 197   3                      }break;
 198   2                      default : break;
 199   2              }
 200   1      }
 201          
 202          /**
 203           * @brief       初始化WIFI模块
 204           * @details     WIFI模块复位需要一定延时；在退出透传模式时延时必须>500ms,每条指令
             -间隔必须>100ms
 205           * @param       None
 206           * @retval      None
 207           */
 208          void Wifi_Init(void)
 209          {
 210   1              uint8_t i = 0;
 211   1      
 212   1              /*WIFI硬件引脚不复位*/
 213   1              WIFI_RESET  = 1;
 214   1              WIFI_RELOAD = 1;
 215   1              /*等待模块复位*/
 216   1              Delay_ms(500);
 217   1      
 218   1              for(i = 0; i < WIFI_CMDSIZE; i++)
 219   1              {
 220   2                      // Uartx_SendStr(&Uart2, (uint8_t *)Wifi_Cmd[i].pSend, strlen(Wifi_Cmd[i].pSend));
 221   2                      // /*执行对应的等待时间*/
 222   2                      // Delay_ms(Wifi_Cmd[i].WaitTimes);
 223   2                      Exe_Appoint_Cmd((uint8_t *)Wifi_Cmd[i].pSend, Wifi_Cmd[i].WaitTimes);
 224   2              }
 225   1      }
 226          
 227          /**
 228           * @brief       WIFI模块执行指令表中特定指令
 229           * @details     
 230           * @param       None
 231           * @retval      None
 232           */
 233          static void Exe_Appoint_Cmd(uint8_t *str, uint16_t times)
 234          {
 235   1              if((str != NULL) && (times))
 236   1              {
 237   2                      Uartx_SendStr(&Uart2, str, strlen(str));
 238   2                      Delay_ms(times);
 239   2              }
C51 COMPILER V9.60.0.0   WIFI                                                              12/21/2021 17:57:20 PAGE 5   

 240   1      }
 241          
 242          
 243          /**
 244           * @brief       WIFI模块退出透传模式
 245           * @details     
 246           * @param       None
 247           * @retval      None
 248           */
 249          static void Wifi_Exit_Trt(void)
 250          {
 251   1              
 252   1              uint8_t i = 0;
 253   1      
 254   1              for(i = 0; i < 2U; i++)
 255   1              {
 256   2                      if((Wifi_Cmd[i].pSend != '\0') && (Wifi_Cmd[i].WaitTimes))
 257   2                      {
 258   3                              // Uartx_SendStr(&Uart2, (uint8_t *)Wifi_Cmd[i].pSend, strlen(Wifi_Cmd[i].pSend));
 259   3                              // /*执行对应的等待时间*/
 260   3                              // Delay_ms(Wifi_Cmd[i].WaitTimes);
 261   3                              Exe_Appoint_Cmd((uint8_t *)Wifi_Cmd[i].pSend, Wifi_Cmd[i].WaitTimes);
 262   3                      }
 263   2              }
 264   1      }
 265          
 266          /**
 267           * @brief       打开WIFI模块热点
 268           * @details     
 269           * @param       None
 270           * @retval      None
 271           */
 272          void Wifi_Open_Ap(void)
 273          {
 274   1              /*退出透传模式*/
 275   1              Wifi_Exit_Trt();
 276   1              /*发送配置指令*/
 277   1              Exe_Appoint_Cmd(AP_STA_MODE, 200);
 278   1              /*进入透传模式*/
 279   1              Exe_Appoint_Cmd(ENTM_CMD, 200);
 280   1              /*重启模块*/
 281   1              Exe_Appoint_Cmd(RESTART_CMD, 200);
 282   1      }
 283          
 284          /**
 285           * @brief       关闭WIFI模块热点
 286           * @details     
 287           * @param       None
 288           * @retval      None
 289           */
 290          void Wifi_Close_Ap(void)
 291          {       
 292   1              /*退出透传模式*/
 293   1              Wifi_Exit_Trt();
 294   1              /*发送配置指令*/
 295   1              Exe_Appoint_Cmd(STA_MODE, 200);
 296   1              /*进入透传模式*/
 297   1              Exe_Appoint_Cmd(ENTM_CMD, 200);
 298   1              /*重启模块*/
 299   1              Exe_Appoint_Cmd(RESTART_CMD, 200);
 300   1      }

C51 COMPILER V9.60.0.0   WIFI                                                              12/21/2021 17:57:20 PAGE 6   


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    303    ----
   CONSTANT SIZE    =    427    ----
   XDATA SIZE       =   ----       7
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)

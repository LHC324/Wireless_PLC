C51 COMPILER V9.60.0.0   MAIN                                                              12/18/2021 09:21:03 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Source\main.c LARGE OPTIMIZE(9,SIZE) BROWSE INCDIR(.\Include;.\FreeModBu
                    -s\Inc) DEBUG OBJECTEXTEND PRINT(.\Listings\main.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          //#include "config.h"
   2          #include "Menu.h"
   3          #include "timer.h"
   4          #include "usart.h"
   5          //#include "systemTimer.h"
   6          #include "eeprom.h"
   7          #include "GPIO.h"
   8          #include "LCD.h"
   9          #include "Key.h"
  10          #include "Control.h"
  11          #include "pFunc.h"
  12          #include "report.h"
  13          #include "mdrtuslave.h"
  14          #include "wifi.h"
  15          
  16          /*系统参数*/
  17          SYSTEM_PARAMETER System_Parameter = {0, false, false, "\xFF\xFF\xFF\xFF", "\x08\x08\x02\x08", 0x01, 0x01, 
             -0x00, 0x00,0x487e};
  18          
  19          static void systemInit(void);
  20          static void UsartHandle(void);
  21          static void Iap_Flash_Iinit(void);
  22          
  23          void main(void)
  24          {
  25   1          systemInit(); //系统初始化
  26   1      
  27   1          while(1)
  28   1          {   /*按键*/
  29   2                      KeyEvent(); 
  30   2                      /*多串口数据处理*/
  31   2                      Uart_Handle();
  32   2                      /*ModBus接收数据处理*/
  33   2      //        mdRTU_Handler();
  34   2          }
  35   1      }
  36          
  37          void systemInit(void)
  38          {
  39   1              Init_All(); //初始化外设
  40   1              
  41   1              /***********************************************************************/
  42   1          //以太网串口结构体初始化
  43   1          Init_ListQueue(&COM_UART1);
  44   1              memset(&COM_UART1,  0, sizeof(COM_UART1));
  45   1              
  46   1              // 4G串口结构体初始化
  47   1          Init_ListQueue(&COM_UART2);
  48   1              memset(&COM_UART2, 0, sizeof(COM_UART2));
  49   1              
  50   1              // RS485串口结构体初始化
  51   1          Init_ListQueue(&COM_UART3);
  52   1              memset(&COM_UART3, 0, sizeof(COM_UART3));
  53   1              
C51 COMPILER V9.60.0.0   MAIN                                                              12/18/2021 09:21:03 PAGE 2   

  54   1              // PLC串口结构体初始化
  55   1          Init_ListQueue(&COM_UART4);
  56   1              memset(&COM_UART4, 0, sizeof(COM_UART4));
  57   1      
  58   1              /***********************************************************************/
  59   1              /*液晶屏初始化*/
  60   1          initial_lcd();  
  61   1          /*系统参数存储区初始化*/
  62   1          Iap_Flash_Iinit();
  63   1          /*以下为系统滴答定时器的初始化（10ms （不建议更改））*/      
  64   1          Timer0_Init();
  65   1          PublicTimer16.MenuDly16.Timer16Flag = false;
  66   1          // /*控件变量初始化,放在串口3初始化之前*/
  67   1          // ControlInit();   
  68   1          /*STC程序下载/printf/以太网*/
  69   1          Uart1_Init(); 
  70   1          /*4G模块*/
  71   1          Uart2_Init(); 
  72   1          /*RS485*/
  73   1          Uart3_Init(); 
  74   1          /*PLC*/
  75   1          Uart4_Init(); 
  76   1          /*串口3的485使能引脚，初始化为接收状态*/
  77   1          USART3_EN = 0; 
  78   1          /*控件变量初始化,放在串口3初始化之前*/
  79   1          ControlInit();
  80   1          /*打开全局中断*/
  81   1          OPEN_GLOBAL_OUTAGE(); 
  82   1              /*初始化Modbus协议栈*/
  83   1      //      ModbusInit();
  84   1          /*显示界面初始化*/ 
  85   1          LcdShowInit();
  86   1          if(System_Parameter.WifiInitFlag == false)
  87   1          {
  88   2              /*初始化WIIF模块*/
  89   2              Wifi_Init(); 
  90   2              System_Parameter.WifiInitFlag = true; 
  91   2              /*存储到IAPFLASH*/
  92   2              ControlSave();
  93   2          }
  94   1          /*看门狗初始化 */ 
  95   1      //      WDT_init();
  96   1      }
  97          
  98          /************************************外设初始化************************************/
  99          void  Init_All(void)
 100          {
 101   1          GPIO_InitTypeDef GPIO_InitStruct;
 102   1      
 103   1      //    #ifdef EXTERNAL_CRYSTAL //只要有宏名，就成立
 104   1              #if EXTERNAL_CRYSTAL
 105   1          P_SW2 = 0x80;
 106   1          XOSCCR = 0xC0;
 107   1          /*启动外部晶振20MHz*/
 108   1          while (!(XOSCCR & 1));             
 109   1          /*时钟不分频*/
 110   1          CLKDIV = 0x01;  
 111   1          /*选择外部晶振 */                    
 112   1          CKSEL = 0x01;                    
 113   1          P_SW2 = 0x00;
 114   1          #endif
 115   1      //  P_SW1 = 0xC0; //串口1切换到P4.3、4.4(P0.2、0.3)
C51 COMPILER V9.60.0.0   MAIN                                                              12/18/2021 09:21:03 PAGE 3   

 116   1      //      P_SW2 |= 0x01; //串口2切换到P4.0、4.2(P1.0、1.1)（新板子引脚问题）
 117   1      
 118   1          //手册提示，串口1、2、3、4的发送引脚必须设置为强挽输出
 119   1              /*P0.x引脚输出方式*/
 120   1          /*设置P0.0、P0.2为准双向口*/
 121   1              GPIO_InitStruct.Mode = GPIO_PullUp;
 122   1          GPIO_InitStruct.Pin  = GPIO_Pin_0 | GPIO_Pin_2;
 123   1          GPIO_Inilize(GPIO_P0, &GPIO_InitStruct);
 124   1          /*设置P0.1为强挽输出 、设置P0.3为强挽输出*/
 125   1              GPIO_InitStruct.Mode = GPIO_OUT_PP;
 126   1          GPIO_InitStruct.Pin  = GPIO_Pin_1 | GPIO_Pin_3;
 127   1          GPIO_Inilize(GPIO_P0, &GPIO_InitStruct);
 128   1      
 129   1              /*P1.x引脚输出方式*/
 130   1          /*设置P1.0为准双向口*/
 131   1              GPIO_InitStruct.Mode = GPIO_PullUp;
 132   1          GPIO_InitStruct.Pin  = GPIO_Pin_0;
 133   1          GPIO_Inilize(GPIO_P1, &GPIO_InitStruct);
 134   1          /*设置P1.1、P1.4、 P1.5为强挽输出*/
 135   1              GPIO_InitStruct.Mode = GPIO_OUT_PP;
 136   1          GPIO_InitStruct.Pin  = GPIO_Pin_1 | GPIO_Pin_4 | GPIO_Pin_5;
 137   1          GPIO_Inilize(GPIO_P1, &GPIO_InitStruct);
 138   1      
 139   1          /*P2.x引脚输出方式*/
 140   1          /*按键相关P2.2、P2.3、P2.4、P2.5、P2.6为高阻态*/
 141   1          GPIO_InitStruct.Mode = GPIO_HighZ;
 142   1          GPIO_InitStruct.Pin  = GPIO_Pin_2 | GPIO_Pin_3 | GPIO_Pin_4 | GPIO_Pin_5 | GPIO_Pin_6;
 143   1          GPIO_Inilize(GPIO_P2, &GPIO_InitStruct);
 144   1      
 145   1              /*P3.x引脚输出方式*/
 146   1          /*设置P3.0为准双向口*/
 147   1              GPIO_InitStruct.Mode = GPIO_PullUp;
 148   1          GPIO_InitStruct.Pin  = GPIO_Pin_0;
 149   1          GPIO_Inilize(GPIO_P3, &GPIO_InitStruct);
 150   1      
 151   1          /*设置P3.1为强挽输出*/
 152   1              GPIO_InitStruct.Mode = GPIO_OUT_PP;
 153   1          GPIO_InitStruct.Pin  = GPIO_Pin_1;
 154   1          GPIO_Inilize(GPIO_P3, &GPIO_InitStruct);
 155   1          
 156   1      }
 157          /************************************外设初始化************************************/
 158          
 159          
 160          /************************************检查IAP区FLASH内容************************************/
 161          bit CheckIap_Flash(void)
 162          {
 163   1          uint16_t CRC = 0;
 164   1      
 165   1              /*读取存储区数据*/
 166   1              IapRead_Buff(START_SAVEADDRESS, &System_Parameter.PSWNext.PassWordbuff[0], (sizeof(System_Parameter) - (s
             -izeof(PASSWORDSTRUCT) - 4U))); 
 167   1              /*计算CRC校验码*/
 168   1              CRC = getCrc16(&System_Parameter.PSWNext.PassWordbuff[0], (sizeof(System_Parameter) - (sizeof(PASSWORDSTR
             -UCT) - 4U) - 2U), 0xffff);   
 169   1              /*比较当前校验码和存储区校验码是否匹配*/
 170   1              if(CRC == System_Parameter.CRC16)
 171   1              {
 172   2                      return true;
 173   2              }
 174   1              return false;
 175   1      }
C51 COMPILER V9.60.0.0   MAIN                                                              12/18/2021 09:21:03 PAGE 4   

 176          
 177          
 178          void Iap_Flash_Iinit(void)
 179          {   /*检查eeprom参数是否正确*/
 180   1          if(CheckIap_Flash())  
 181   1          {
 182   2              GUI_String(14, 31, "parameters are correct !", EN_5_8);
 183   2              Delay_ms(1000);
 184   2          }
 185   1          else
 186   1          {
 187   2              GUI_String(19, 31, "parameters error !", EN_5_8);
 188   2              Delay_ms(500);
 189   2              GUI_String(19, 31, "restore parameters...", EN_5_8);
 190   2                      
 191   2                      /*每次写之前必须进行擦除操作：擦除每次按照512B进行(0x00-0x0200)*/
 192   2              IapErase(START_SAVEADDRESS); 
 193   2                      /*把默认参数拷贝到当前数据结构*/
 194   2                      memcpy(&System_Parameter.PSWNext.PassWordbuff[0], DEFAULT_SYSTEM_PARAMETER, (sizeof(System_Parameter) - 
             -(sizeof(PASSWORDSTRUCT) - 4U))); 
 195   2                      /*把数据进行存储*/
 196   2              IapWrite_Buff(START_SAVEADDRESS, &System_Parameter.PSWNext.PassWordbuff[0], (sizeof(System_Paramet
             -er) - (sizeof(PASSWORDSTRUCT) - 4U))); //去掉一个字节的index
 197   2      
 198   2              Delay_ms(1000);
 199   2              clear_screen();
 200   2              GUI_String(49, 31, "successfully !", EN_5_8);
 201   2              Delay_ms(500);
 202   2          }
 203   1      }
 204          /************************************检查IAP区FLASH内容************************************/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    489    ----
   CONSTANT SIZE    =     96    ----
   XDATA SIZE       =     17       2
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)

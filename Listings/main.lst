C51 COMPILER V9.60.0.0   MAIN                                                              12/22/2021 11:18:20 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Source\main.c LARGE OPTIMIZE(9,SIZE) BROWSE INCDIR(.\Include;.\FreeModBu
                    -s\Inc) DEBUG OBJECTEXTEND PRINT(.\Listings\main.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          //#include "config.h"
   2          #include "Menu.h"
   3          #include "timer.h"
   4          #include "usart.h"
   5          //#include "systemTimer.h"
   6          #include "eeprom.h"
   7          #include "GPIO.h"
   8          #include "LCD.h"
   9          #include "Key.h"
  10          #include "Control.h"
  11          #include "pFunc.h"
  12          #include "report.h"
  13          #include "mdrtuslave.h"
  14          #include "wifi.h"
  15          
  16          /*系统参数*/
  17          SYSTEM_PARAMETER System_Parameter = {0, false, false, "\xFF\xFF\xFF\xFF", "\x08\x08\x02\x08", 0x01, 0x01, 
             -0x00, 0x00, 0x01, 0x02, 0x3671};
  18          
  19          static void systemInit(void);
  20          static void UsartHandle(void);
  21          static void Iap_Flash_Iinit(void);
  22          
  23          /*定义一个静态内存池*/
  24          // uint8_t mempool[5U * 1024] = {0};
  25          
  26          void main(void)
  27          {   /*注意传递的是数组名地址*/
  28   1          // init_mempool (mempool, sizeof(mempool)); 
  29   1          systemInit(); //系统初始化
  30   1      
  31   1          while(1)
  32   1          {   /*按键*/
  33   2                      KeyEvent(); 
  34   2                      /*多串口数据处理*/
  35   2                      Uart_Handle();
  36   2                      /*ModBus接收数据处理*/
  37   2      //        mdRTU_Handler();
  38   2          }
  39   1      }
  40          
  41          void systemInit(void)
  42          {
  43   1          Init_All(); //初始化外设
  44   1              
  45   1              /***********************************************************************/
  46   1          //以太网串口结构体初始化
  47   1          Init_ListQueue(&COM_UART1);
  48   1              memset(&COM_UART1,  0, sizeof(COM_UART1));
  49   1              
  50   1              // 4G串口结构体初始化
  51   1          Init_ListQueue(&COM_UART2);
  52   1              memset(&COM_UART2, 0, sizeof(COM_UART2));
  53   1              
C51 COMPILER V9.60.0.0   MAIN                                                              12/22/2021 11:18:20 PAGE 2   

  54   1              // RS485串口结构体初始化
  55   1          Init_ListQueue(&COM_UART3);
  56   1              memset(&COM_UART3, 0, sizeof(COM_UART3));
  57   1              
  58   1              // PLC串口结构体初始化
  59   1          Init_ListQueue(&COM_UART4);
  60   1              memset(&COM_UART4, 0, sizeof(COM_UART4));
  61   1      
  62   1              /***********************************************************************/
  63   1              /*液晶屏初始化*/
  64   1          initial_lcd();  
  65   1          /*系统参数存储区初始化*/
  66   1          Iap_Flash_Iinit();
  67   1          /*以下为系统滴答定时器的初始化（10ms （不建议更改））*/      
  68   1          Timer0_Init();
  69   1          PublicTimer16.MenuDly16.Timer16Flag = false;
  70   1          // /*控件变量初始化,放在串口3初始化之前*/
  71   1          // ControlInit();   
  72   1          /*STC程序下载/printf/以太网*/
  73   1          Uart1_Init(); 
  74   1          /*4G模块*/
  75   1          Uart2_Init(); 
  76   1          /*RS485*/
  77   1          Uart3_Init(); 
  78   1          /*PLC*/
  79   1          Uart4_Init(); 
  80   1          /*串口3的485使能引脚，初始化为接收状态*/
  81   1          USART3_EN = 0; 
  82   1          /*控件变量初始化,放在串口3初始化之前*/
  83   1          ControlInit();
  84   1          /*打开全局中断*/
  85   1          OPEN_GLOBAL_OUTAGE(); 
  86   1              /*初始化Modbus协议栈*/
  87   1      //      ModbusInit();
  88   1          /*显示界面初始化*/ 
  89   1          LcdShowInit();
  90   1          if(System_Parameter.WifiInitFlag == false)
  91   1          {
  92   2              /*初始化WIIF模块*/
  93   2              Wifi_Init(); 
  94   2              System_Parameter.WifiInitFlag = true; 
  95   2              /*存储到IAPFLASH*/
  96   2              ControlSave();
  97   2          }
  98   1          /*看门狗初始化 */ 
  99   1      //      WDT_init();
 100   1      }
 101          
 102          /************************************外设初始化************************************/
 103          void  Init_All(void)
 104          {
 105   1          GPIO_InitTypeDef GPIO_InitStruct;
 106   1      
 107   1      //    #ifdef EXTERNAL_CRYSTAL //只要有宏名，就成立
 108   1              #if EXTERNAL_CRYSTAL
                  P_SW2 = 0x80;
                  XOSCCR = 0xC0;
                  /*启动外部晶振20MHz*/
                  while (!(XOSCCR & 1));             
                  /*时钟不分频*/
                  CLKDIV = 0x01;  
                  /*选择外部晶振 */                    
C51 COMPILER V9.60.0.0   MAIN                                                              12/22/2021 11:18:20 PAGE 3   

                  CKSEL = 0x01;                    
                  P_SW2 = 0x00;
                  #endif
 119   1      //  P_SW1 = 0xC0; //串口1切换到P4.3、4.4(P0.2、0.3)
 120   1      //      P_SW2 |= 0x01; //串口2切换到P4.0、4.2(P1.0、1.1)（新板子引脚问题）
 121   1      
 122   1          //手册提示，串口1、2、3、4的发送引脚必须设置为强挽输出
 123   1              /*P0.x引脚输出方式*/
 124   1          /*设置P0.0、P0.2为准双向口*/
 125   1              GPIO_InitStruct.Mode = GPIO_PullUp;
 126   1          GPIO_InitStruct.Pin  = GPIO_Pin_0 | GPIO_Pin_2;
 127   1          GPIO_Inilize(GPIO_P0, &GPIO_InitStruct);
 128   1          /*设置P0.1为强挽输出 、设置P0.3为强挽输出*/
 129   1              GPIO_InitStruct.Mode = GPIO_OUT_PP;
 130   1          GPIO_InitStruct.Pin  = GPIO_Pin_1 | GPIO_Pin_3;
 131   1          GPIO_Inilize(GPIO_P0, &GPIO_InitStruct);
 132   1      
 133   1              /*P1.x引脚输出方式*/
 134   1          /*设置P1.0为准双向口*/
 135   1              GPIO_InitStruct.Mode = GPIO_PullUp;
 136   1          GPIO_InitStruct.Pin  = GPIO_Pin_0;
 137   1          GPIO_Inilize(GPIO_P1, &GPIO_InitStruct);
 138   1          /*设置P1.1、P1.4、 P1.5为强挽输出*/
 139   1              GPIO_InitStruct.Mode = GPIO_OUT_PP;
 140   1          GPIO_InitStruct.Pin  = GPIO_Pin_1 | GPIO_Pin_4 | GPIO_Pin_5;
 141   1          GPIO_Inilize(GPIO_P1, &GPIO_InitStruct);
 142   1      
 143   1          /*P2.x引脚输出方式*/
 144   1          /*按键相关P2.2、P2.3、P2.4、P2.5、P2.6为高阻态*/
 145   1          GPIO_InitStruct.Mode = GPIO_HighZ;
 146   1          GPIO_InitStruct.Pin  = GPIO_Pin_2 | GPIO_Pin_3 | GPIO_Pin_4 | GPIO_Pin_5 | GPIO_Pin_6;
 147   1          GPIO_Inilize(GPIO_P2, &GPIO_InitStruct);
 148   1      
 149   1              /*P3.x引脚输出方式*/
 150   1          /*设置P3.0为准双向口*/
 151   1              GPIO_InitStruct.Mode = GPIO_PullUp;
 152   1          GPIO_InitStruct.Pin  = GPIO_Pin_0;
 153   1          GPIO_Inilize(GPIO_P3, &GPIO_InitStruct);
 154   1      
 155   1          /*设置P3.1为强挽输出*/
 156   1              GPIO_InitStruct.Mode = GPIO_OUT_PP;
 157   1          GPIO_InitStruct.Pin  = GPIO_Pin_1;
 158   1          GPIO_Inilize(GPIO_P3, &GPIO_InitStruct);
 159   1          
 160   1      }
 161          /************************************外设初始化************************************/
 162          
 163          
 164          /************************************检查IAP区FLASH内容************************************/
 165          bit CheckIap_Flash(void)
 166          {
 167   1          uint16_t CRC = 0;
 168   1      
 169   1              /*读取存储区数据*/
 170   1              IapRead_Buff(START_SAVEADDRESS, &System_Parameter.PSWNext.PassWordbuff[0], (sizeof(System_Parameter) - (s
             -izeof(PASSWORDSTRUCT) - 4U))); 
 171   1              /*计算CRC校验码*/
 172   1              CRC = getCrc16(&System_Parameter.PSWNext.PassWordbuff[0], (sizeof(System_Parameter) - (sizeof(PASSWORDSTR
             -UCT) - 4U) - 2U), 0xffff);   
 173   1              /*比较当前校验码和存储区校验码是否匹配*/
 174   1              if(CRC == System_Parameter.CRC16)
 175   1              {
C51 COMPILER V9.60.0.0   MAIN                                                              12/22/2021 11:18:20 PAGE 4   

 176   2                      return true;
 177   2              }
 178   1              return false;
 179   1      }
 180          
 181          
 182          void Iap_Flash_Iinit(void)
 183          {   /*检查eeprom参数是否正确*/
 184   1          if(CheckIap_Flash())  
 185   1          {
 186   2              GUI_String(14, 31, "parameters are correct !", EN_5_8);
 187   2              Delay_ms(1000);
 188   2          }
 189   1          else
 190   1          {
 191   2              GUI_String(19, 31, "parameters error !", EN_5_8);
 192   2              Delay_ms(500);
 193   2              GUI_String(19, 31, "restore parameters...", EN_5_8);
 194   2                      
 195   2                      /*每次写之前必须进行擦除操作：擦除每次按照512B进行(0x00-0x0200)*/
 196   2              IapErase(START_SAVEADDRESS); 
 197   2                      /*把默认参数拷贝到当前数据结构*/
 198   2                      memcpy(&System_Parameter.PSWNext.PassWordbuff[0], DEFAULT_SYSTEM_PARAMETER, (sizeof(System_Parameter) - 
             -(sizeof(PASSWORDSTRUCT) - 4U))); 
 199   2                      /*把数据进行存储*/
 200   2              IapWrite_Buff(START_SAVEADDRESS, &System_Parameter.PSWNext.PassWordbuff[0], (sizeof(System_Paramet
             -er) - (sizeof(PASSWORDSTRUCT) - 4U))); //去掉一个字节的index
 201   2      
 202   2              Delay_ms(1000);
 203   2              clear_screen();
 204   2              GUI_String(49, 31, "successfully !", EN_5_8);
 205   2              Delay_ms(500);
 206   2          }
 207   1      }
 208          /************************************检查IAP区FLASH内容************************************/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    461    ----
   CONSTANT SIZE    =     98    ----
   XDATA SIZE       =     19       2
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
